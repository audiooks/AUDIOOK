<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AUDIOOK ‚Äî Player</title>
<style>
  :root{
    --bg:#071018;
    --card:#0d1a1f;
    --muted:#99a6b3;
    --accent:#1DB954; /* green-ish accent */
    --pill:#0b1416;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#050708 0%, #071018 100%);font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#eaf2ff}
  .wrap{max-width:760px;margin:18px auto;padding:18px}
  .card{background:linear-gradient(180deg,var(--card), #071014);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .logo{display:block;margin:0 auto 12px auto;height:72px;object-fit:contain}
  .cover-wrap{position:relative;border-radius:14px;overflow:hidden;background:linear-gradient(135deg,#2b7cff,#7b3fff);padding-bottom:56%;} /* aspect ratio */
  .cover-wrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  /* central play button overlay */
  .play-overlay{
    position:absolute;left:50%;bottom: -28px;transform:translateX(-50%);width:92px;height:92px;border-radius:50%;
    display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.6));
    box-shadow:0 10px 30px rgba(0,0,0,.6);
    border:4px solid rgba(255,255,255,0.03);
  }
  .play-overlay button{width:66px;height:66px;border-radius:50%;border:0;background:var(--accent);color:#04120c;font-size:22px;cursor:pointer;box-shadow:0 6px 18px rgba(28,139,78,0.15)}
  .meta{padding:34px 8px 6px 8px;text-align:left}
  .title{font-size:22px;margin:0 0 6px 0;color:#eaf2ff;font-weight:700;display:none} /* hidden as requested */
  .sub{color:var(--muted);margin-bottom:18px}
  .controls{display:flex;align-items:center;justify-content:space-between;padding:6px 4px;gap:8px}
  .btns{display:flex;align-items:center;gap:10px}
  .icon-btn{background:var(--glass);border-radius:10px;padding:10px;border:0;color:#fff;cursor:pointer;min-width:44px;display:grid;place-items:center}
  .accent-btn{background:linear-gradient(180deg,var(--accent),#16b84a);border-radius:50%;padding:14px;border:0;color:#04120c;cursor:pointer;box-shadow:0 6px 20px rgba(27,121,74,0.12)}
  .seek-row{display:flex;align-items:center;gap:12px;margin-top:14px}
  .time{color:var(--muted);width:48px;text-align:center;font-size:13px}
  .seek{flex:1}
  input[type=range]{width:100%;appearance:none;height:8px;border-radius:8px;background:rgba(255,255,255,0.06);outline:none}
  input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 2px 6px rgba(27,121,74,0.6);border:3px solid rgba(255,255,255,0.03)}
  .message{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;color:#cfe7ff}
  .captions{margin-top:14px;max-height:320px;overflow:auto;padding:8px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))}
  .cue{padding:12px;border-radius:8px;margin-bottom:8px;background:transparent;color:#d7e7f8}
  .cue-time{color:var(--muted);font-size:12px;margin-bottom:8px}
  .cue.active{background:linear-gradient(90deg, rgba(27,121,74,0.08), rgba(27,121,74,0.02));box-shadow: inset 0 1px 0 rgba(255,255,255,0.02)}
  /* responsive */
  @media(max-width:640px){ .wrap{padding:12px} .play-overlay{bottom:-34px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="playerCard">
      <!-- logo -->
      <img src="Untitled%20design.png" alt="AUDIOOK" class="logo" id="logoImg">

      <!-- cover with play overlay -->
      <div class="cover-wrap" id="coverWrap">
        <img id="coverImg" src="" alt="cover image">
        <div class="play-overlay" id="playOverlay">
          <button id="centralPlay" aria-label="Play">‚ñ∂</button>
        </div>
      </div>

      <!-- meta & controls area -->
      <div class="meta">
        <div class="title" id="titleText"></div>
        <div class="sub" id="subtitle"> </div>

        <div class="controls">
          <div class="btns">
            <button class="icon-btn" id="shuffleBtn" title="Shuffle">üîÄ</button>
            <button class="icon-btn" id="prevBtn" title="Previous">‚èÆ</button>
            <button class="icon-btn" id="rew10Btn" title="Rewind 10s">‚è™ 10s</button>
          </div>

          <div style="display:flex;align-items:center;gap:10px">
            <button class="accent-btn" id="playBtn" title="Play">‚ñ∂</button>
            <div style="width:10px"></div>
            <div class="btns">
              <button class="icon-btn" id="fwd10Btn" title="Forward 10s">10s ‚è©</button>
              <button class="icon-btn" id="nextBtn" title="Next">‚è≠</button>
            </div>
          </div>

          <button class="icon-btn" id="ccBtn" title="Toggle captions">CC</button>
        </div>

        <div class="seek-row">
          <div class="time" id="curTime">0:00</div>
          <div class="seek"><input type="range" id="seekBar" value="0" min="0" step="0.1"></div>
          <div class="time" id="durTime">0:00</div>
        </div>

        <div class="message" id="statusBox" style="display:none"></div>

        <div class="captions" id="transcript"></div>

        <!-- hidden audio element (no native controls) -->
        <audio id="audio" crossorigin="anonymous"></audio>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqZ4QkKxAGZsmQbi5XrWZiSFuzakxwJJvPabUjJ9su8rRNYe3pxz9R7VTmxpvFXHCsuOZqLbVtzZHZ/pub?gid=892865560&single=true&output=csv";

/* ELEMENTS */
const audio = document.getElementById('audio');
const coverImg = document.getElementById('coverImg');
const centralPlay = document.getElementById('centralPlay');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const rew10Btn = document.getElementById('rew10Btn');
const fwd10Btn = document.getElementById('fwd10Btn');
const seekBar = document.getElementById('seekBar');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const transcriptEl = document.getElementById('transcript');
const statusBox = document.getElementById('statusBox');
const ccBtn = document.getElementById('ccBtn');
const shuffleBtn = document.getElementById('shuffleBtn');

/* STATE */
let playlist = []; // {title, image, audio, captionUrl, id}
let currentIndex = 0;
let cues = [];
let captionsOn = true;
let rafId = null;
let shuffled = false;

/* small CSV parser that handles quoted cells */
function parseCSV(text) {
  const rows = [];
  let cur = [];
  let i=0, token='', inQuotes=false;
  while(i<text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ token += '"'; i+=2; continue; }
        else { inQuotes = false; i++; continue; }
      } else { token += c; i++; continue; }
    } else {
      if(c === '"'){ inQuotes = true; i++; continue; }
      if(c === ','){ cur.push(token); token=''; i++; continue; }
      if(c === '\r'){ i++; continue; }
      if(c === '\n'){ cur.push(token); token=''; rows.push(cur); cur=[]; i++; continue; }
      token += c; i++; continue;
    }
  }
  // last cell
  if(token.length || cur.length) { cur.push(token); rows.push(cur); }
  return rows;
}

/* Load playlist from CSV (Title, ImageURL, AudioURL, optional CaptionURL) */
async function loadPlaylist(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('CSV fetch failed: '+res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if(rows.length < 2) { statusBox.style.display='block'; statusBox.textContent='No rows in sheet'; return; }
    const header = rows.shift();
    playlist = rows.map((r, idx) => {
      return {
        id: (r[0] && r[0].trim()) ? r[0].trim() : String(idx+1), // if sheet first col is id or title, fallback to index
        title: r[0] || '',
        image: r[1] || '',
        audio: r[2] || '',
        captionUrl: r[3] && r[3].trim() ? r[3].trim() : `vtt/${idx+1}.vtt`
      }
    }).filter(p => p.audio); // require audio
    if(playlist.length===0){ statusBox.style.display='block'; statusBox.textContent='No audio rows found'; }
    else loadTrack(currentIndex);
  }catch(err){
    console.error(err);
    statusBox.style.display='block';
    statusBox.textContent = 'Failed to load playlist: ' + err.message;
  }
}

/* Load a track by index */
async function loadTrack(index){
  cancelRAF();
  currentIndex = Math.max(0, Math.min(index, playlist.length-1));
  const t = playlist[currentIndex];
  // update UI
  coverImg.src = t.image || '';
  // set audio
  audio.src = t.audio;
  audio.crossOrigin = 'anonymous';
  seekBar.value = 0; curTime.textContent='0:00'; durTime.textContent='0:00';
  // try to load captions
  cues = [];
  transcriptEl.innerHTML = '';
  captionBoxHide(false);
  await loadVTT(t.captionUrl);
  // ensure play button shows play icon until user presses
  playBtn.textContent = '‚ñ∂';
  centralPlay.textContent = '‚ñ∂';
}

/* load vtt and build transcript UI */
async function loadVTT(url){
  if(!url){ captionBoxHide(); return; }
  try{
    const r = await fetch(url);
    if(!r.ok){ captionBoxHide(); return; }
    const txt = await r.text();
    cues = parseVTT(txt);
    buildTranscriptUI();
  }catch(e){
    console.warn('vtt load failed', e);
    captionBoxHide();
  }
}

/* parse VTT into cues {start,end,text} */
function parseVTT(txt){
  txt = txt.replace(/\r/g,'');
  const lines = txt.split('\n');
  const cues = []; let i=0;
  while(i<lines.length){
    let line = lines[i].trim();
    if(!line){ i++; continue; }
    // skip numeric index lines
    if(/^\d+$/.test(line)){ i++; line = lines[i] ? lines[i].trim() : ''; }
    if(line && line.includes('-->')){
      const parts = line.split('-->');
      const start = toSeconds(parts[0].trim());
      const end = toSeconds(parts[1].trim());
      i++;
      let textLines=[];
      while(i<lines.length && lines[i].trim()!==''){
        textLines.push(lines[i]);
        i++;
      }
      cues.push({start,end,text:textLines.join('\n')});
    } else { i++; }
  }
  return cues;
}

/* build transcript DOM */
function buildTranscriptUI(){
  transcriptEl.innerHTML = '';
  cues.forEach((c, idx) => {
    const d = document.createElement('div');
    d.className = 'cue';
    d.dataset.idx = idx;
    d.dataset.start = c.start;
    d.innerHTML = `<div class="cue-time">${formatTime(c.start)}</div><div class="cue-text">${escapeHtml(c.text)}</div>`;
    d.addEventListener('click', ()=>{ audio.currentTime = Number(d.dataset.start)+0.02; if(audio.paused){ audio.play(); playBtn.textContent='‚è∏'; centralPlay.textContent='‚è∏'; } updateActiveCue(idx); });
    transcriptEl.appendChild(d);
  });
}

/* helpers */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function toSeconds(t){ t = t.replace(',', '.'); const p = t.split(':').map(Number); if(p.length===3) return p[0]*3600+p[1]*60+p[2]; if(p.length===2) return p[0]*60+p[1]; return Number(t); }
function formatTime(s){ if(isNaN(s)) return '0:00'; s = Math.floor(s); const m=Math.floor(s/60); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
function captionBoxHide(show=false){ if(!show){ transcriptEl.style.display='none'; ccBtn.style.opacity=0.4; } else { transcriptEl.style.display='block'; ccBtn.style.opacity=1; } }

/* playback handlers */
function onPlay(){
  playBtn.textContent='‚è∏';
  centralPlay.textContent='‚è∏';
  startRAF();
}
function onPause(){
  playBtn.textContent='‚ñ∂';
  centralPlay.textContent='‚ñ∂';
  cancelRAF();
}
function onEnded(){
  // advance to next track (loop)
  if(playlist.length>1) nextTrack();
  else { audio.currentTime = 0; audio.pause(); onPause(); }
}

/* UI event wiring */
centralPlay.addEventListener('click', ()=>{ togglePlay(); });
playBtn.addEventListener('click', ()=>{ togglePlay(); });
prevBtn.addEventListener('click', ()=>{ audio.currentTime=0; audio.play(); });
nextBtn.addEventListener('click', ()=>{ if(playlist.length>1) nextTrack(); else { audio.currentTime=0; audio.play(); } });
rew10Btn.addEventListener('click', ()=>{ audio.currentTime = Math.max(0, audio.currentTime - 10); });
fwd10Btn.addEventListener('click', ()=>{ audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 10); });
ccBtn.addEventListener('click', ()=>{ captionsOn = !captionsOn; transcriptEl.style.display = captionsOn ? 'block' : 'none'; ccBtn.style.opacity = captionsOn ? 1 : 0.4; });
shuffleBtn.addEventListener('click', ()=>{ shuffled = !shuffled; shuffleBtn.style.opacity = shuffled?1:0.6; if(shuffled) shufflePlaylist(); else loadPlaylist(); });

audio.addEventListener('loadedmetadata', ()=>{
  seekBar.max = audio.duration || 0;
  durTime.textContent = formatTime(audio.duration);
});
audio.addEventListener('timeupdate', ()=>{
  seekBar.value = audio.currentTime;
  curTime.textContent = formatTime(audio.currentTime);
  updateCues(audio.currentTime);
});
audio.addEventListener('play', onPlay);
audio.addEventListener('pause', onPause);
audio.addEventListener('ended', onEnded);

seekBar.addEventListener('input', ()=>{ audio.currentTime = Number(seekBar.value); });

function togglePlay(){
  if(audio.paused){ audio.play(); } else { audio.pause(); }
}

/* requestAnimation for fine updates (used for transcript highlight) */
function startRAF(){
  cancelRAF();
  function step(){
    updateCues(audio.currentTime);
    rafId = requestAnimationFrame(step);
  }
  rafId = requestAnimationFrame(step);
}
function cancelRAF(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }

/* highlight active cue and keep it visible */
function updateCues(time){
  if(!cues || cues.length===0){ return; }
  let active = -1;
  for(let i=0;i<cues.length;i++){
    if(time >= cues[i].start && time < cues[i].end){ active = i; break; }
  }
  updateActiveCue(active);
}
function updateActiveCue(idx){
  const nodes = transcriptEl.querySelectorAll('.cue');
  nodes.forEach((n,i)=> n.classList.toggle('active', i===idx));
  if(idx>=0){
    const el = transcriptEl.children[idx];
    const rect = el.getBoundingClientRect();
    const parentRect = transcriptEl.getBoundingClientRect();
    if(rect.top < parentRect.top || rect.bottom > parentRect.bottom){
      el.scrollIntoView({behavior:'smooth',block:'center'});
    }
  }
}

/* playlist navigation */
function nextTrack(){
  currentIndex = (currentIndex + 1) % playlist.length;
  loadTrack(currentIndex);
  audio.play();
}
function shufflePlaylist(){
  // simple fisher-yates
  for(let i=playlist.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
  }
  loadTrack(0);
}

/* initial load */
loadPlaylist();
</script>
</body>
  </html>
