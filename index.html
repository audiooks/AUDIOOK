<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AUDIOOKS Player</title>
<style>
  :root {
    --bg: #0b0f14; 
    --muted: #a4b0bd; 
    --accent: #d97706;
  }
  html,body {
    height: 100%;
    margin: 0;
    font-family: Inter, system-ui, Arial;
    background: linear-gradient(180deg, #081018 0%, #071923 100%);
    color: #e6eef8;
    display: flex;
    justify-content: center;
  }
  .wrap {
    max-width: 500px;
    width: 100%;
    padding: 18px;
    box-sizing: border-box;
  }
  .logo {
    display: block;
    margin: 0 auto;
    max-height: 70px;
  }
  .app-title {
    text-align: center;
    font-size: 26px;
    font-weight: 800;
    color: var(--accent);
    margin: 6px 0 18px 0;
  }
  .card {
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
  }
  .art {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 12px;
    overflow: hidden;
    background: linear-gradient(135deg, var(--accent), #6e49ff);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 42px;
    color: white;
    margin-bottom: 16px;
  }
  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }
  .btn {
    background: var(--accent);
    border: none;
    color: white;
    padding: 10px;
    border-radius: 10px;
    font-size: 20px;
    cursor: pointer;
  }
  .playbig {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: var(--accent);
    font-size: 28px;
    box-shadow: 0 6px 20px rgba(0,0,0,.5);
  }
  .seek {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  input[type=range] {
    flex: 1;
  }
  .time {
    width: 50px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
  }
  .caption-box {
    margin-top: 14px;
    padding: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    font-weight: 600;
    min-height: 36px;
    text-align: center;
  }
</style>
</head>
<body>
  <div class="wrap">
    <img src="audiooks-logo.png" alt="AUDIOOKS Logo" class="logo" id="logoImg">
    <div class="app-title">AUDIOOKS</div>

    <div class="card" id="playerCard">
      <div class="art" id="artEl">A</div>

      <div class="controls">
        <button class="btn" id="prevBtn" title="Previous">⏮</button>
        <button class="btn" id="rewBtn" title="Rewind 10s">⏪10s</button>
        <button class="playbig" id="playBtn" title="Play">▶️</button>
        <button class="btn" id="ffBtn" title="Forward 10s">10s⏩</button>
        <button class="btn" id="nextBtn" title="Next">⏭</button>
        <button class="btn" id="ccBtn" title="Toggle captions">CC</button>
      </div>

      <div class="seek">
        <div class="time" id="curTime">0:00</div>
        <input id="seek" type="range" min="0" max="100" step="0.01" value="0" />
        <div class="time" id="durTime">0:00</div>
      </div>

      <div class="caption-box" id="captionBox">Captions will appear here</div>

      <audio id="audio" crossorigin="anonymous"></audio>
    </div>
  </div>

<script>
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const rewBtn = document.getElementById('rewBtn');
const ffBtn = document.getElementById('ffBtn');
const ccBtn = document.getElementById('ccBtn');
const seek = document.getElementById('seek');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const artEl = document.getElementById('artEl');
const captionBox = document.getElementById('captionBox');

let raf = null;
let captionsOn = true;
let transcript = [];

function getParam(name){
  try { return new URLSearchParams(location.search).get(name); } catch(e){ return null; }
}

const audioSrc = getParam('audio') || '';
const imageSrc = getParam('image') || '';
const captionsSrc = getParam('captions') || '';

if (audioSrc) audio.src = audioSrc;
if (imageSrc) artEl.innerHTML = `<img src="${imageSrc}" style="width:100%;height:100%;object-fit:cover">`;

async function loadVTT(url){
  try {
    const res = await fetch(url);
    const txt = await res.text();
    return parseVTT(txt);
  } catch(e){
    console.warn('VTT load error', e);
    return [];
  }
}

function parseVTT(data){
  const lines = data.replace(/\r/g,'').split('\n');
  const cues = [];
  let i = 0;
  while (i < lines.length){
    const line = lines[i].trim();
    if (!line) { i++; continue; }
    const timecodePattern = /(\d+:\d{2}:\d{2}\.\d{3}|\d{2}:\d{2}\.\d{3}) --> (\d+:\d{2}:\d{2}\.\d{3}|\d{2}:\d{2}\.\d{3})/;
    if (timecodePattern.test(line)){
      const [startStr, endStr] = line.split('-->').map(s=>s.trim());
      const start = timeToSeconds(startStr);
      const end = timeToSeconds(endStr);
      i++;
      let textLines = [];
      while (i < lines.length && lines[i].trim()){
        textLines.push(lines[i]);
        i++;
      }
      cues.push({start, end, text: textLines.join(' ')});
    } else i++;
  }
  return cues;
}

function timeToSeconds(t){
  const parts = t.split(':');
  let sec = 0;
  if (parts.length === 3){
    sec = (+parts[0])*3600 + (+parts[1])*60 + (+parts[2]);
  } else if (parts.length === 2){
    sec = (+parts[0])*60 + (+parts[1]);
  }
  return sec;
}

function formatTime(s){
  s = Math.floor(s);
  const m = Math.floor(s/60);
  const sec = (s%60).toString().padStart(2,'0');
  return `${m}:${sec}`;
}

playBtn.addEventListener('click', ()=>{ if (audio.paused) audio.play(); else audio.pause(); });
prevBtn.addEventListener('click', ()=>{ audio.currentTime = 0; });
nextBtn.addEventListener('click', ()=>{ audio.currentTime = audio.duration; });
rewBtn.addEventListener('click', ()=>{ audio.currentTime = Math.max(0, audio.currentTime - 10); });
ffBtn.addEventListener('click', ()=>{ audio.currentTime = Math.min(audio.duration, audio.currentTime + 10); });
ccBtn.addEventListener('click', ()=>{ captionsOn = !captionsOn; captionBox.style.display = captionsOn ? 'block' : 'none'; });

seek.addEventListener('input', ()=>{ curTime.textContent = formatTime(seek.value); });
seek.addEventListener('change', ()=>{ audio.currentTime = seek.value; });

audio.addEventListener('loadedmetadata', ()=>{ seek.max = audio.duration; durTime.textContent = formatTime(audio.duration); });
audio.addEventListener('play', ()=>{ playBtn.textContent = '⏸'; startRAF(); });
audio.addEventListener('pause', ()=>{ playBtn.textContent = '▶️'; cancelAnimationFrame(raf); });
audio.addEventListener('timeupdate', ()=>{ if (captionsOn) updateCaptions(); });

function startRAF(){
  function step(){
    seek.value = audio.currentTime;
    curTime.textContent = formatTime(audio.currentTime);
    raf = requestAnimationFrame(step);
  }
  raf = requestAnimationFrame(step);
}

function updateCaptions(){
  const t = audio.currentTime;
  let active = transcript.find(c => t >= c.start && t < c.end);
  captionBox.textContent = active ? active.text : '';
}

(async function init(){
  if (captionsSrc) transcript = await loadVTT(captionsSrc);
})();
</script>
</body>
  </html>
